<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>模型调试工具</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.15.0/dist/tf-backend-webgl.min.js"></script>
</head>
<body>
    <h1>YOLO 模型调试</h1>
    <div id="output"></div>

    <script>
        async function debugModel() {
            const output = document.getElementById('output');
            
            try {
                output.innerHTML += '<p>🔄 正在加载模型...</p>';
                
                await tf.ready();
                console.log('TensorFlow.js 后端:', tf.getBackend());
                
                const model = await tf.loadGraphModel('/public/models/yolodetection/model.json');
                
                output.innerHTML += '<p>✅ 模型加载成功</p>';
                
                // 详细检查模型结构
                console.log('完整模型对象:', model);
                console.log('模型输入:', model.inputs);
                console.log('模型输出:', model.outputs);
                console.log('输入节点:', model.inputNodes);
                console.log('输出节点:', model.outputNodes);
                
                output.innerHTML += `<p><strong>输入数量:</strong> ${model.inputs.length}</p>`;
                output.innerHTML += `<p><strong>输出数量:</strong> ${model.outputs.length}</p>`;
                
                // 检查每个输入
                model.inputs.forEach((input, i) => {
                    console.log(`输入 ${i}:`, input);
                    output.innerHTML += `<p><strong>输入 ${i}:</strong> 形状 ${JSON.stringify(input.shape)}, 名称: ${input.name || 'N/A'}</p>`;
                });
                
                // 检查每个输出
                model.outputs.forEach((output_tensor, i) => {
                    console.log(`输出 ${i}:`, output_tensor);
                    output.innerHTML += `<p><strong>输出 ${i}:</strong> 形状 ${JSON.stringify(output_tensor.shape)}, 名称: ${output_tensor.name || 'N/A'}</p>`;
                });
                
                // 尝试推理测试
                output.innerHTML += '<p>🧪 正在进行推理测试...</p>';
                const testInput = tf.randomNormal([1, 640, 640, 3]);
                console.log('测试输入形状:', testInput.shape);
                
                const prediction = model.predict(testInput);
                console.log('预测结果:', prediction);
                
                if (Array.isArray(prediction)) {
                    output.innerHTML += `<p><strong>输出类型:</strong> Array, 长度: ${prediction.length}</p>`;
                    prediction.forEach((pred, i) => {
                        console.log(`预测输出 ${i}:`, pred);
                        output.innerHTML += `<p><strong>预测输出 ${i}:</strong> 形状 ${JSON.stringify(pred.shape)}</p>`;
                    });
                } else {
                    console.log('单一预测输出:', prediction);
                    output.innerHTML += `<p><strong>预测输出形状:</strong> ${JSON.stringify(prediction.shape)}</p>`;
                }
                
                // 清理
                testInput.dispose();
                if (Array.isArray(prediction)) {
                    prediction.forEach(p => p.dispose());
                } else {
                    prediction.dispose();
                }
                
                output.innerHTML += '<p>✅ 调试完成</p>';
                
            } catch (error) {
                console.error('调试失败:', error);
                output.innerHTML += `<p>❌ 错误: ${error.message}</p>`;
            }
        }
        
        window.addEventListener('load', debugModel);
    </script>
</body>
</html>