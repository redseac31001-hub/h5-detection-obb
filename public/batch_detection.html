<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO批量检测系统</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.15.0/dist/tf-backend-webgl.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1600px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold; 
        }
        .loading { background: #e3f2fd; color: #1976d2; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .error { background: #ffebee; color: #c62828; }
        .warning { background: #fff3e0; color: #f57c00; }
        
        .controls { 
            display: flex; 
            gap: 15px; 
            align-items: center; 
            flex-wrap: wrap; 
            margin: 20px 0; 
        }
        .control-group { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
        }
        .control-group label { 
            font-weight: bold; 
            font-size: 14px; 
        }
        .control-group input, .control-group select { 
            padding: 5px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        
        .image-selection {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .image-item {
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .image-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .image-item.selected {
            border: 3px solid #4caf50;
            background: #e8f5e8;
        }
        .image-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
        }
        .image-name {
            text-align: center;
            font-size: 12px;
            margin-top: 5px;
            word-break: break-all;
        }
        
        .batch-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 15px 0;
        }
        
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            background: #2196f3; 
            color: white; 
            cursor: pointer; 
            font-size: 16px; 
        }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.success { background: #4caf50; }
        button.warning { background: #ff9800; }
        
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        .stat-card { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .stat-value { 
            font-size: 24px; 
            font-weight: bold; 
            color: #2196f3; 
        }
        .stat-label { 
            font-size: 14px; 
            color: #666; 
            margin-top: 5px; 
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .result-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result-image {
            position: relative;
            margin-bottom: 15px;
        }
        .result-image img {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 4px;
        }
        .result-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        .result-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .detection-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .detection-item {
            background: #e8f5e8;
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #4caf50;
            font-size: 14px;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4caf50, #66bb6a);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🍽️ YOLO餐具检测 - 批量处理系统</h1>
        
        <div id="status" class="status loading">正在初始化模型...</div>
        
        <div class="controls">
            <div class="control-group">
                <label>置信度阈值:</label>
                <input type="range" id="confidenceThreshold" min="0.01" max="0.9" step="0.01" value="0.15">
                <span id="confidenceValue">0.15</span>
            </div>
            
            <div class="control-group">
                <label>NMS IoU阈值:</label>
                <input type="range" id="iouThreshold" min="0.1" max="0.8" step="0.05" value="0.5">
                <span id="iouValue">0.5</span>
            </div>
            
            <div class="control-group">
                <label>检测模式:</label>
                <select id="detectionMode">
                    <option value="single">单张检测</option>
                    <option value="batch">批量检测</option>
                    <option value="all">检测所有</option>
                </select>
            </div>
        </div>
        
        <div class="image-selection">
            <div class="batch-controls">
                <button onclick="selectAll()" type="button">全选</button>
                <button onclick="selectNone()" type="button">取消选择</button>
                <button id="startBtn" onclick="startDetection()" disabled>开始检测</button>
                <button onclick="clearResults()" type="button">清除结果</button>
                <span id="selectedCount">已选择: 0 张图片</span>
            </div>
            
            <div class="progress-bar" id="progressContainer" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText"></div>
            
            <div class="image-grid" id="imageGrid">
                <!-- 图片列表将在这里动态生成 -->
            </div>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalImages">0</div>
                <div class="stat-label">总图片数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="processedImages">0</div>
                <div class="stat-label">已处理</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalDetections">0</div>
                <div class="stat-label">总检测数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalValue">¥0.00</div>
                <div class="stat-label">总价值</div>
            </div>
        </div>
        
        <div id="results" class="results-grid">
            <!-- 检测结果将在这里显示 -->
        </div>
    </div>

    <script>
        let model = null;
        let isModelLoaded = false;
        let selectedImages = new Set();
        let isProcessing = false;
        
        const classNames = [
            'Fruit_Bowl',
            'Large_Dish_for_Vegetables', 
            'Large_Noodle_Bowl',
            'Oval_Plate_for_Staple_Food',
            'Small_Dish_for_Vegetables',
            'Small_Noodle_Bowl',
            'Yogurt_Container'
        ];
        
        const priceMapping = {
            'Fruit_Bowl': 15.0,
            'Large_Dish_for_Vegetables': 18.0,
            'Large_Noodle_Bowl': 22.0,
            'Oval_Plate_for_Staple_Food': 25.0,
            'Small_Dish_for_Vegetables': 12.0,
            'Small_Noodle_Bowl': 18.0,
            'Yogurt_Container': 8.0
        };
        
        // 测试图片列表
        const testImages = [
            '111532922-src.jpg',
            '111641052-src.jpg',
            '112452304-src.jpg',
            '112736596-src.jpg',
            '113157040-src.jpg',
            '115012512-src.jpg',
            '120644058-src.jpg',
            '120903272-src.jpg',
            '121816058-src.jpg',
            '121837504-src.jpg',
            '122637793-src.jpg',
            '122705692-src.jpg',
            '122718526-src.jpg',
            '124522499-src.jpg',
            '124559018-src.jpg',
            '124645455-src.jpg'
        ];

        // 参数控制
        document.getElementById('confidenceThreshold').addEventListener('input', function() {
            document.getElementById('confidenceValue').textContent = this.value;
        });
        
        document.getElementById('iouThreshold').addEventListener('input', function() {
            document.getElementById('iouValue').textContent = this.value;
        });

        document.getElementById('detectionMode').addEventListener('change', function() {
            if (this.value === 'all') {
                selectAll();
            } else if (this.value === 'single') {
                selectNone();
            }
        });

        async function initializeModel() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.innerHTML = '🔄 正在初始化 TensorFlow.js...';
                await tf.ready();
                console.log('TensorFlow.js 后端:', tf.getBackend());
                
                statusDiv.innerHTML = '📥 正在加载 YOLO 模型...';
                model = await tf.loadGraphModel('/models/yolodetection/model.json');
                
                console.log('✅ 模型加载成功');
                isModelLoaded = true;
                statusDiv.innerHTML = '✅ 模型加载完成，准备检测！';
                statusDiv.className = 'status success';
                
                // 初始化图片网格
                initializeImageGrid();
                updateStartButton();
                
            } catch (error) {
                console.error('❌ 模型加载失败:', error);
                statusDiv.innerHTML = '❌ 模型加载失败: ' + error.message;
                statusDiv.className = 'status error';
            }
        }
        
        function initializeImageGrid() {
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';
            
            testImages.forEach((imageName, index) => {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.onclick = () => toggleImageSelection(imageName, imageItem);
                
                imageItem.innerHTML = `
                    <img src="/test/${imageName}" alt="${imageName}" 
                         onerror="this.style.display='none'">
                    <div class="image-name">${imageName}</div>
                `;
                
                grid.appendChild(imageItem);
            });
            
            document.getElementById('totalImages').textContent = testImages.length;
        }
        
        function toggleImageSelection(imageName, element) {
            if (selectedImages.has(imageName)) {
                selectedImages.delete(imageName);
                element.classList.remove('selected');
            } else {
                selectedImages.add(imageName);
                element.classList.add('selected');
            }
            
            updateSelectedCount();
            updateStartButton();
        }
        
        function selectAll() {
            selectedImages.clear();
            testImages.forEach(imageName => selectedImages.add(imageName));
            
            document.querySelectorAll('.image-item').forEach(item => {
                item.classList.add('selected');
            });
            
            updateSelectedCount();
            updateStartButton();
        }
        
        function selectNone() {
            selectedImages.clear();
            
            document.querySelectorAll('.image-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            updateSelectedCount();
            updateStartButton();
        }
        
        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = `已选择: ${selectedImages.size} 张图片`;
        }
        
        function updateStartButton() {
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = !(isModelLoaded && selectedImages.size > 0) || isProcessing;
        }

        async function startDetection() {
            if (!model || !isModelLoaded || selectedImages.size === 0 || isProcessing) {
                return;
            }
            
            isProcessing = true;
            updateStartButton();
            
            const statusDiv = document.getElementById('status');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            statusDiv.innerHTML = '🔍 开始批量检测...';
            statusDiv.className = 'status loading';
            progressContainer.style.display = 'block';
            
            const selectedImageArray = Array.from(selectedImages);
            let processedCount = 0;
            let totalDetections = 0;
            let totalPrice = 0;
            
            // 清除之前的结果
            document.getElementById('results').innerHTML = '';
            
            for (let i = 0; i < selectedImageArray.length; i++) {
                const imageName = selectedImageArray[i];
                
                try {
                    // 更新进度
                    const progress = ((i / selectedImageArray.length) * 100);
                    progressFill.style.width = progress + '%';
                    progressText.textContent = `正在处理: ${imageName} (${i + 1}/${selectedImageArray.length})`;
                    
                    statusDiv.innerHTML = `🔍 检测中: ${imageName} (${i + 1}/${selectedImageArray.length})`;
                    
                    // 执行检测
                    const result = await detectSingleImage(imageName);
                    
                    if (result) {
                        processedCount++;
                        totalDetections += result.detections.length;
                        totalPrice += result.totalPrice;
                        
                        // 显示结果
                        displayDetectionResult(result);
                    }
                    
                    // 更新统计
                    updateGlobalStats(processedCount, totalDetections, totalPrice);
                    
                } catch (error) {
                    console.error(`检测 ${imageName} 失败:`, error);
                }
            }
            
            // 完成
            progressFill.style.width = '100%';
            progressText.textContent = `✅ 批量检测完成! 处理了 ${processedCount} 张图片，检测到 ${totalDetections} 个对象`;
            statusDiv.innerHTML = `✅ 批量检测完成! 总共检测到 ${totalDetections} 个餐具对象`;
            statusDiv.className = 'status success';
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
            }, 3000);
            
            isProcessing = false;
            updateStartButton();
        }

        async function detectSingleImage(imageName) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = async () => {
                    try {
                        // 预处理图片
                        const tensor = preprocessImage(img);
                        
                        // 模型推理
                        const predictions = model.predict(tensor);
                        let outputTensor = Array.isArray(predictions) ? predictions[0] : predictions;
                        
                        // 后处理
                        const rawDetections = await postprocessPredictions(outputTensor, img.width, img.height);
                        
                        // 过滤和NMS
                        const confidenceThreshold = parseFloat(document.getElementById('confidenceThreshold').value);
                        const iouThreshold = parseFloat(document.getElementById('iouThreshold').value);
                        
                        const filteredDetections = rawDetections.filter(d => d.confidence >= confidenceThreshold);
                        const finalDetections = applyNMS(filteredDetections, iouThreshold);
                        
                        // 计算总价
                        const totalPrice = finalDetections.reduce((sum, d) => sum + (priceMapping[d.class] || 0), 0);
                        
                        // 清理内存
                        tensor.dispose();
                        if (Array.isArray(predictions)) {
                            predictions.forEach(p => p.dispose());
                        } else {
                            predictions.dispose();
                        }
                        
                        resolve({
                            imageName,
                            image: img,
                            detections: finalDetections,
                            totalPrice,
                            stats: {
                                raw: rawDetections.length,
                                filtered: filteredDetections.length,
                                final: finalDetections.length
                            }
                        });
                        
                    } catch (error) {
                        reject(error);
                    }
                };
                
                img.onerror = () => reject(new Error(`无法加载图片: ${imageName}`));
                img.src = `/test/${imageName}`;
            });
        }

        function preprocessImage(img) {
            let tensor = tf.browser.fromPixels(img);
            tensor = tf.image.resizeBilinear(tensor, [640, 640]);
            tensor = tensor.div(255.0);
            tensor = tensor.expandDims(0);
            return tensor;
        }

        async function postprocessPredictions(predictions, imgWidth, imgHeight) {
            const data = await predictions.data();
            const shape = predictions.shape;
            const detections = [];
            
            if (shape.length === 3 && shape[0] === 1) {
                const [batch, features, numDetections] = shape;
                const scaleX = imgWidth / 640;
                const scaleY = imgHeight / 640;
                
                for (let i = 0; i < numDetections; i++) {
                    const xCenter = data[0 * numDetections + i] * scaleX;
                    const yCenter = data[1 * numDetections + i] * scaleY;
                    const width = data[2 * numDetections + i] * scaleX;
                    const height = data[3 * numDetections + i] * scaleY;
                    
                    let maxClassScore = 0;
                    let maxClassIndex = 0;
                    
                    for (let classIdx = 0; classIdx < 7; classIdx++) {
                        const score = data[(4 + classIdx) * numDetections + i];
                        if (score > maxClassScore) {
                            maxClassScore = score;
                            maxClassIndex = classIdx;
                        }
                    }
                    
                    if (maxClassScore > 0.001) {
                        if (xCenter >= 0 && xCenter <= imgWidth && yCenter >= 0 && yCenter <= imgHeight && 
                            width > 0 && height > 0) {
                            
                            const x = Math.max(0, xCenter - width / 2);
                            const y = Math.max(0, yCenter - height / 2);
                            const w = Math.min(imgWidth - x, width);
                            const h = Math.min(imgHeight - y, height);
                            
                            if (w > 5 && h > 5) {
                                detections.push({
                                    class: classNames[maxClassIndex] || `class_${maxClassIndex}`,
                                    confidence: maxClassScore,
                                    bbox: { x, y, width: w, height: h }
                                });
                            }
                        }
                    }
                }
            }
            
            return detections;
        }

        function applyNMS(detections, iouThreshold = 0.5) {
            if (detections.length === 0) return detections;
            
            const sortedDetections = detections.sort((a, b) => b.confidence - a.confidence);
            const selectedDetections = [];
            
            for (let i = 0; i < sortedDetections.length; i++) {
                const currentDetection = sortedDetections[i];
                let shouldKeep = true;
                
                for (let j = 0; j < selectedDetections.length; j++) {
                    const iou = calculateIoU(currentDetection.bbox, selectedDetections[j].bbox);
                    if (iou > iouThreshold) {
                        shouldKeep = false;
                        break;
                    }
                }
                
                if (shouldKeep) {
                    selectedDetections.push(currentDetection);
                }
            }
            
            return selectedDetections;
        }

        function calculateIoU(box1, box2) {
            const x1 = Math.max(box1.x, box2.x);
            const y1 = Math.max(box1.y, box2.y);
            const x2 = Math.min(box1.x + box1.width, box2.x + box2.width);
            const y2 = Math.min(box1.y + box1.height, box2.y + box2.height);
            
            if (x2 <= x1 || y2 <= y1) return 0;
            
            const intersection = (x2 - x1) * (y2 - y1);
            const area1 = box1.width * box1.height;
            const area2 = box2.width * box2.height;
            const union = area1 + area2 - intersection;
            
            return intersection / union;
        }

        function displayDetectionResult(result) {
            const resultsContainer = document.getElementById('results');
            
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            
            // 创建图片容器
            const imageContainer = document.createElement('div');
            imageContainer.className = 'result-image';
            
            const img = document.createElement('img');
            img.src = result.image.src;
            img.alt = result.imageName;
            
            const canvas = document.createElement('canvas');
            canvas.className = 'result-canvas';
            
            // 获取图片在页面中的显示尺寸
            const displayWidth = img.clientWidth || result.image.width;
            const displayHeight = img.clientHeight || result.image.height;
            
            canvas.width = displayWidth;
            canvas.height = displayHeight;
            
            // 计算缩放比例
            const scaleX = displayWidth / result.image.width;
            const scaleY = displayHeight / result.image.height;
            
            // 绘制检测框
            const ctx = canvas.getContext('2d');
            
            // 等待图片加载完成后再绘制
            img.onload = () => {
                // 重新计算缩放比例
                const actualDisplayWidth = img.clientWidth || img.offsetWidth;
                const actualDisplayHeight = img.clientHeight || img.offsetHeight;
                
                if (actualDisplayWidth && actualDisplayHeight) {
                    canvas.width = actualDisplayWidth;
                    canvas.height = actualDisplayHeight;
                    
                    const scaleX = actualDisplayWidth / result.image.width;
                    const scaleY = actualDisplayHeight / result.image.height;
                    
                    console.log(`图片 ${result.imageName} 缩放比例: x=${scaleX.toFixed(3)}, y=${scaleY.toFixed(3)}`);
                    console.log(`原始尺寸: ${result.image.width}x${result.image.height}, 显示尺寸: ${actualDisplayWidth}x${actualDisplayHeight}`);
                    
                    result.detections.forEach((detection, index) => {
                        const { bbox, class: className, confidence } = detection;
                        
                        // 缩放检测框坐标到显示尺寸
                        const scaledX = bbox.x * scaleX;
                        const scaledY = bbox.y * scaleY;
                        const scaledWidth = bbox.width * scaleX;
                        const scaledHeight = bbox.height * scaleY;
                        
                        console.log(`检测${index}: 原始(${bbox.x.toFixed(1)}, ${bbox.y.toFixed(1)}, ${bbox.width.toFixed(1)}, ${bbox.height.toFixed(1)}) -> 缩放后(${scaledX.toFixed(1)}, ${scaledY.toFixed(1)}, ${scaledWidth.toFixed(1)}, ${scaledHeight.toFixed(1)})`);
                        
                        const alpha = Math.min(1, confidence * 3);
                        
                        // 绘制检测框
                        ctx.strokeStyle = `rgba(76, 175, 80, ${alpha})`;
                        ctx.lineWidth = 2;
                        ctx.strokeRect(scaledX, scaledY, scaledWidth, scaledHeight);
                        
                        // 绘制标签
                        const label = `${className} (${(confidence * 100).toFixed(1)}%)`;
                        ctx.font = '12px Arial';
                        const textWidth = ctx.measureText(label).width;
                        
                        ctx.fillStyle = `rgba(76, 175, 80, ${alpha})`;
                        ctx.fillRect(scaledX, scaledY - 18, textWidth + 6, 18);
                        
                        ctx.fillStyle = 'white';
                        ctx.fillText(label, scaledX + 3, scaledY - 4);
                    });
                }
            };
            
            // 如果图片已经加载，立即触发onload
            if (img.complete) {
                img.onload();
            }
            
            imageContainer.appendChild(img);
            imageContainer.appendChild(canvas);
            
            // 创建信息面板
            const infoPanel = document.createElement('div');
            infoPanel.className = 'result-info';
            infoPanel.innerHTML = `
                <h4>${result.imageName}</h4>
                <p><strong>检测数量:</strong> ${result.detections.length} 个对象</p>
                <p><strong>总价值:</strong> ¥${result.totalPrice.toFixed(2)}</p>
                <p><strong>处理统计:</strong> 原始${result.stats.raw} → 过滤${result.stats.filtered} → 最终${result.stats.final}</p>
            `;
            
            // 创建检测列表
            const detectionList = document.createElement('div');
            detectionList.className = 'detection-list';
            
            result.detections.forEach((detection, index) => {
                const price = priceMapping[detection.class] || 0;
                const item = document.createElement('div');
                item.className = 'detection-item';
                item.innerHTML = `
                    <strong>${detection.class}</strong> - 
                    置信度: ${(detection.confidence * 100).toFixed(1)}% - 
                    价格: ¥${price.toFixed(2)}
                `;
                detectionList.appendChild(item);
            });
            
            resultItem.appendChild(imageContainer);
            resultItem.appendChild(infoPanel);
            resultItem.appendChild(detectionList);
            resultsContainer.appendChild(resultItem);
        }

        function updateGlobalStats(processedImages, totalDetections, totalPrice) {
            document.getElementById('processedImages').textContent = processedImages;
            document.getElementById('totalDetections').textContent = totalDetections;
            document.getElementById('totalValue').textContent = `¥${totalPrice.toFixed(2)}`;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('processedImages').textContent = '0';
            document.getElementById('totalDetections').textContent = '0';
            document.getElementById('totalValue').textContent = '¥0.00';
            
            const progressContainer = document.getElementById('progressContainer');
            progressContainer.style.display = 'none';
        }

        // 页面加载后初始化
        window.addEventListener('load', initializeModel);
    </script>
</body>
</html>